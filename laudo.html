<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>LAUDO — SI</title>

  <style>
    :root{
      --border:rgba(255,255,255,.18);
      --glass1: rgba(255,255,255,.12);
      --glass2: rgba(255,255,255,.06);
      --shadow: 0 18px 55px rgba(0,0,0,.22);
      --blue:#2563eb;
    }

    *{ box-sizing:border-box; }
    html,body{ margin:0; padding:0; height:100%; }

    body{
      font-family: Arial, sans-serif;
      background: transparent;
      color:#fff;
      overflow-x:hidden;
      overflow-y:auto;
      -ms-overflow-style:none;
      scrollbar-width:none;
    }
    body::-webkit-scrollbar{ width:0; height:0; display:none; }

    .screenWrap{ padding: 14px; }

    .screenCard{
      border-radius: 22px;
      border: 1px solid var(--border);
      background: linear-gradient(180deg, var(--glass1), var(--glass2));
      box-shadow: var(--shadow);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      padding: 14px;
    }

    .topBar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      padding: 10px 12px;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.18);
      margin-bottom: 12px;
    }

    .topBar strong{
      font-size: 12px;
      font-weight: 900;
      letter-spacing:.14em;
      text-transform: uppercase;
      color:#fff;
      white-space:nowrap;
    }

    .btn{
      border:none;
      cursor:pointer;
      padding: 10px 14px;
      border-radius: 14px;
      font-weight: 900;
      letter-spacing:.06em;
      text-transform: uppercase;
      font-size: 12px;
      color:#041b2f;
      background: linear-gradient(90deg, #00e09c, #1376b8);
      box-shadow: 0 14px 24px rgba(0,0,0,.18);
    }
    .btn:active{ transform: translateY(1px); }

    .section{
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.12);
      padding: 12px;
      margin-top: 12px;
    }

    .section h3{
      margin:0 0 10px 0;
      font-size: 12px;
      font-weight: 900;
      letter-spacing:.14em;
      text-transform: uppercase;
      color:#fff;
    }

    .subTitle{
      font-size: 12px;
      font-weight: 900;
      margin: 10px 0 6px 0;
      text-transform: uppercase;
      letter-spacing:.06em;
      color: rgba(255,255,255,.92);
    }

    .optRow{
      display:flex;
      gap: 16px;
      flex-wrap:wrap;
      padding: 6px 0;
    }

    label.opt{
      display:flex;
      align-items:center;
      gap: 8px;
      font-size: 12px;
      font-weight: 800;
      color: rgba(255,255,255,.92);
      user-select:none;
    }

    input[type="radio"], input[type="checkbox"]{
      accent-color: var(--blue);
      transform: translateY(1px);
    }

    textarea{
      width:100%;
      min-height: 120px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.18);
      background: rgba(0,0,0,.14);
      color:#fff;
      padding: 12px;
      font-family: Arial, sans-serif;
      font-size: 13px;
      line-height: 1.45;
      resize: vertical;
      outline:none;
    }

    /* ====================== IMPRESSÃO ====================== */
    .printWrap{ display:none; }

    @media print{
      body{ background:#fff !important; color:#111827 !important; overflow: visible !important; }
      .screenWrap{ display:none !important; }
      .printWrap{ display:block !important; }

      .printPage{
        position: relative;
        width: 210mm;
        min-height: 297mm;
        margin: 0 auto;
        background:#fff;
      }

      .pdfBase{
        position:absolute;
        inset:0;
        width:100%;
        height:100%;
        z-index:0;
      }

      .printOverlay{
        position:absolute;
        inset:0;
        z-index:1;
        padding: 12mm 12mm 16mm 12mm;
        font-family: "Arial Narrow", Arial, sans-serif;
        font-size: 10pt;
        color:#000;
      }

      .cabecalhoBox{
        border: 1px solid #cbd5e1;
        border-radius: 10px;
        padding: 10px 12px;
        margin-bottom: 10px;
      }

      .cabGrid{
        display:grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
      }

      .cabLine{
        display:flex;
        justify-content:space-between;
        gap: 10px;
        font-size: 10pt;
        margin: 4px 0;
      }

      .cabLine b{ font-weight: 700; }

      .rightBox{
        display:flex;
        flex-direction:column;
        gap: 6px;
      }

      .laudoConteudo{
        border: 1px solid #cbd5e1;
        border-radius: 10px;
        padding: 12px;
      }

      .laudoConteudo pre{
        margin:0;
        white-space:pre-wrap;
        font-family: "Arial Narrow", Arial, sans-serif;
        font-size: 10pt;
        line-height: 1.3;
      }
    }
  </style>
</head>

<body>

  <!-- ✅ TELA: FORMULÁRIO -->
  <div class="screenWrap">
    <div class="screenCard">
      <div class="topBar">
        <strong>LAUDO — DIGITAÇÃO</strong>
      </div>

      <!-- 1 -->
      <div class="section">
        <h3>1. Avaliação pré-analítica</h3>

        <div class="subTitle">Adequabilidade</div>
        <div class="optRow">
          <label class="opt"><input type="radio" name="adequabilidade" value="Satisfatória"> Satisfatória</label>
          <label class="opt"><input type="radio" name="adequabilidade" value="Insatisfatória"> Insatisfatória</label>
        </div>

        <div class="subTitle">Epitélios</div>
        <div class="optRow">
          <label class="opt"><input type="checkbox" id="epi_escamoso"> Escamoso</label>
          <label class="opt"><input type="checkbox" id="epi_glandular"> Glandular</label>
          <label class="opt"><input type="checkbox" id="epi_metaplasico"> Metaplásico</label>
        </div>

        <div class="subTitle">Zona de transformação</div>
        <div class="optRow">
          <label class="opt"><input type="radio" name="zona" id="zona_sim" value="Sim"> Sim</label>
          <label class="opt"><input type="radio" name="zona" id="zona_nao" value="Não"> Não</label>
        </div>
      </div>

      <!-- 2 -->
      <div class="section">
        <h3>2. Diagnóstico descritivo</h3>
        <div class="optRow">
          <label class="opt"><input type="radio" name="diag" value="D1"> DENTRO DOS LIMITES DA NORMALIDADE NO MATERIAL EXAMINADO</label>
        </div>
        <div class="optRow">
          <label class="opt"><input type="radio" name="diag" value="D2"> ALTERAÇÕES CELULARES BENIGNAS REATIVAS OU REPARATIVAS</label>
        </div>

        <!-- ✅ Só fica isso aqui na tela -->
        <div class="subTitle">Alterações celulares benignas</div>
        <div class="optRow">
          <label class="opt"><input type="checkbox" id="ben_inflamacao"> Inflamação</label>
          <label class="opt"><input type="checkbox" id="ben_metaplasia"> Metaplasia escamosa imatura</label>
          <label class="opt"><input type="checkbox" id="ben_reparacao"> Reparação</label>
          <label class="opt"><input type="checkbox" id="ben_atrofia"> Atrofia com inflamação</label>
          <label class="opt"><input type="checkbox" id="ben_radiacao"> Radiação</label>
        </div>
      </div>

      <!-- 3 -->
      <div class="section">
        <h3>3. Microbiologia</h3>
        <div class="optRow">
          <label class="opt"><input type="checkbox" id="mic_lacto"> Lactobacillus sp</label>
          <label class="opt"><input type="checkbox" id="mic_cocos"> Cocos</label>
          <label class="opt"><input type="checkbox" id="mic_chlamydia"> Sugestivo de Chlamydia sp</label>
          <label class="opt"><input type="checkbox" id="mic_actinomyces"> Actinomyces sp</label>
          <label class="opt"><input type="checkbox" id="mic_candida"> Candida sp</label>
          <label class="opt"><input type="checkbox" id="mic_trich"> Trichomonas vaginalis</label>
          <label class="opt"><input type="checkbox" id="mic_gard"> Gardnerella/Mobiluncus</label>
          <label class="opt"><input type="checkbox" id="mic_hpv"> Vírus Herpes</label>
        </div>
      </div>

      <!-- 4 -->
      <div class="section">
        <h3>4. Conclusão técnica</h3>
        <div class="optRow">
          <label class="opt"><input type="radio" name="conclusao" value="Negativo para malignidade"> NEGATIVO PARA MALIGNIDADE</label>
          <label class="opt"><input type="radio" name="conclusao" value="Inflamação"> INFLAMAÇÃO</label>
          <label class="opt"><input type="radio" name="conclusao" value="Alterações benignas"> ALTERAÇÕES BENIGNAS</label>
        </div>

        <div class="subTitle">Células atípicas</div>
        <div class="optRow">
          <label class="opt"><input type="radio" name="atipias" value="AC1">
            ESCAMOSAS: Não se pode afastar lesão de alto grau (ASC-H).
          </label>
          <label class="opt"><input type="radio" name="atipias" value="AC2">
            ATIPIAS EM CÉLULAS ESCAMOSAS
          </label>
          <label class="opt"><input type="radio" name="atipias" value="AC3">
            ATIPIAS EM CÉLULAS GLANDULARES — Adenocarcinoma "in situ".
          </label>
        </div>
      </div>

      <!-- Observação -->
      <div class="section">
        <h3>Observação (para o laudo)</h3>
        <textarea id="obsLaudo" placeholder="Digite aqui as observações do laudo..."></textarea>
      </div>

      <!-- ✅ imprimir no final -->
      <div style="margin-top:12px;">
        <button class="btn" id="btnImprimir" type="button" style="width:100%;">IMPRIMIR</button>
      </div>

    </div>
  </div>

  <!-- ✅ IMPRESSÃO -->
  <div class="printWrap">
    <div class="printPage">
      <iframe class="pdfBase" id="pdfBase" src=""></iframe>

      <div class="printOverlay">
        <div class="cabecalhoBox">
          <div class="cabGrid">
            <div class="rightBox">
              <div class="cabLine"><span><b>Paciente:</b></span> <span id="p_paciente">—</span></div>
              <div class="cabLine"><span><b>Data coleta:</b></span> <span id="p_data_coleta">—</span></div>
              <div class="cabLine"><span><b>Nascimento:</b></span> <span id="p_data_nascimento">—</span></div>
              <div class="cabLine"><span><b>Endereço:</b></span> <span id="p_endereco">—</span></div>
            </div>

            <div class="rightBox">
              <div class="cabLine"><span><b>Nº exame:</b></span> <span id="p_exame">—</span></div>
              <div class="cabLine"><span><b>Cartão SUS:</b></span> <span id="p_sus">—</span></div>
              <div class="cabLine"><span><b>Telefone:</b></span> <span id="p_tel">—</span></div>
              <div class="cabLine"><span><b>Cidade / CEP:</b></span> <span id="p_cidadecep">—</span></div>
              <div class="cabLine"><span><b>Obs:</b></span> <span id="p_obscab">—</span></div>
            </div>
          </div>
        </div>

        <div class="laudoConteudo">
          <pre id="p_textoLaudo">—</pre>
        </div>
      </div>
    </div>
  </div>

  <script>
    const $ = (id)=>document.getElementById(id);

    function getParam(nome){
      return new URLSearchParams(window.location.search).get(nome) || "";
    }

    function lerDadosCabecalho(){
      const dados = {
        paciente: getParam("paciente"),
        exame: getParam("exame"),
        data_coleta: getParam("data_coleta"),
        data_nascimento: getParam("data_nascimento"),
        cartao_sus: getParam("cartao_sus"),
        telefone: getParam("telefone"),
        rua: getParam("rua"),
        bairro: getParam("bairro"),
        cidade: getParam("cidade"),
        cep: getParam("cep"),
        observacao: getParam("observacao")
      };

      if(!dados.paciente){
        try{
          const ls = JSON.parse(localStorage.getItem("SI_DADOS_LAUDO") || "{}");
          Object.assign(dados, ls);
        }catch(e){}
      }
      return dados;
    }

    function montarEndereco(d){
      const a = [];
      if(d.rua) a.push(d.rua);
      if(d.bairro) a.push("— " + d.bairro);
      return a.length ? a.join(" ") : "—";
    }

    function montarCidadeCep(d){
      const a = [];
      if(d.cidade) a.push(d.cidade);
      if(d.cep) a.push(d.cep);
      return a.length ? a.join(" — ") : "—";
    }

    function valRadio(name){
      const el = document.querySelector(`input[name="${name}"]:checked`);
      return el ? el.value : "";
    }

    function listChecks(map){
      return Object.entries(map)
        .filter(([id])=> document.getElementById(id).checked)
        .map(([,label])=> label);
    }

    function montarTextoLaudo(){
      const adequa = valRadio("adequabilidade");
      const zona = valRadio("zona");
      const diag = valRadio("diag");
      const concl = valRadio("conclusao");
      const atip = valRadio("atipias");
      const obs = ($("obsLaudo").value || "").trim();

      const epitelios = listChecks({
        "epi_escamoso":"Escamoso",
        "epi_glandular":"Glandular",
        "epi_metaplasico":"Metaplásico"
      });

      const benignas = listChecks({
        "ben_inflamacao":"Inflamação",
        "ben_metaplasia":"Metaplasia escamosa imatura",
        "ben_reparacao":"Reparação",
        "ben_atrofia":"Atrofia com inflamação",
        "ben_radiacao":"Radiação"
      });

      const micro = listChecks({
        "mic_lacto":"Lactobacillus sp",
        "mic_cocos":"Cocos",
        "mic_chlamydia":"Sugestivo de Chlamydia sp",
        "mic_actinomyces":"Actinomyces sp",
        "mic_candida":"Candida sp",
        "mic_trich":"Trichomonas vaginalis",
        "mic_gard":"Gardnerella/Mobiluncus",
        "mic_hpv":"Vírus Herpes"
      });

      let out = "";
      out += "LAUDO DO EXAME CITOPATOLÓGICO DO COLO DO ÚTERO\n\n";

      out += "1. AVALIAÇÃO PRÉ-ANALÍTICA\n";
      if(adequa) out += `ADEQUABILIDADE: ${adequa}\n`;
      if(epitelios.length) out += `EPITÉLIOS: ${epitelios.join(", ")}\n`;
      if(zona) out += `ZONA DE TRANSFORMAÇÃO: ${zona}\n`;
      out += "\n";

      out += "2. DIAGNÓSTICO DESCRITIVO\n";
      if(diag === "D1") out += "DENTRO DOS LIMITES DA NORMALIDADE NO MATERIAL EXAMINADO\n";
      if(diag === "D2"){
        out += "ALTERAÇÕES CELULARES BENIGNAS REATIVAS OU REPARATIVAS:\n";
        if(benignas.length) benignas.forEach(x=> out += `  - ${x}\n`);
      }
      out += "\n";

      out += "3. MICROBIOLOGIA\n";
      if(micro.length) micro.forEach(x=> out += `  - ${x}\n`);
      else out += "  - —\n";
      out += "\n";

      out += "4. CONCLUSÃO TÉCNICA\n";
      if(concl) out += `${concl}\n`;

      if(atip === "AC1"){
        out += "\nCÉLULAS ATÍPICAS DE SIGNIFICADO INDETERMINADO:\n";
        out += "                                - ESCAMOSAS: Não se pode afastar lesão de alto grau (ASC-H).\n";
      }
      if(atip === "AC2") out += "\nATIPIAS EM CÉLULAS ESCAMOSAS:\n";
      if(atip === "AC3"){
        out += "\nATIPIAS EM CÉLULAS GLANDULARES:\n";
        out += '      - Adenocarcinoma "in situ".\n';
      }

      if(obs){
        out += "\nOBSERVAÇÕES:\n";
        out += obs + "\n";
      }

      return out.trim();
    }

    /* ✅ agora chama modelo certo */
    function escolherTemplate(){
      const diag = valRadio("diag");
      const atip = valRadio("atipias");

      if(atip === "AC1") return "AC1.pdf";
      if(atip === "AC2") return "AC2.pdf";
      if(atip === "AC3") return "AC3.pdf";

      if(diag === "D2") return "D2.pdf";
      return "D1.pdf";
    }

    function preencherImpressao(){
      const d = lerDadosCabecalho();

      $("p_paciente").textContent = d.paciente || "—";
      $("p_exame").textContent = d.exame || "—";
      $("p_data_coleta").textContent = d.data_coleta || "—";
      $("p_data_nascimento").textContent = d.data_nascimento || "—";
      $("p_sus").textContent = d.cartao_sus || "—";
      $("p_tel").textContent = d.telefone || "—";
      $("p_endereco").textContent = montarEndereco(d);
      $("p_cidadecep").textContent = montarCidadeCep(d);
      $("p_obscab").textContent = d.observacao || "—";

      $("p_textoLaudo").textContent = montarTextoLaudo();

      const pdf = escolherTemplate();
      $("pdfBase").src = `${pdf}?v=${Date.now()}`;
    }

    function aplicarRegrasAuto(){
      const zonaNao = $("zona_nao");
      const zonaSim = $("zona_sim");
      const e1 = $("epi_escamoso");
      const e2 = $("epi_glandular");
      const e3 = $("epi_metaplasico");

      zonaNao.addEventListener("change", ()=>{
        if(zonaNao.checked){
          e1.checked = false;
          e2.checked = false;
          e3.checked = false;
        }
      });

      [e1,e2,e3].forEach(el=>{
        el.addEventListener("change", ()=>{
          const any = e1.checked || e2.checked || e3.checked;
          if(any) zonaSim.checked = true;
        });
      });
    }

    window.addEventListener("load", aplicarRegrasAuto);

    $("btnImprimir").addEventListener("click", ()=>{
      preencherImpressao();
      setTimeout(()=> window.print(), 80);
    });
  </script>

</body>
</html>
